<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - Blessings Clinic</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  
  <script>
    // Custom Tailwind Configuration for Deep Blue Theme
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['Inter', 'sans-serif'],
          },
          colors: {
            'primary-indigo': '#3730a3', /* Deep, rich Indigo (Authority) */
            'secondary-blue': '#3b82f6', /* Medium Blue (Call to action) */
            'tertiary-slate': '#475569', /* Dark Slate/Gray (Text/Accents) */
            'blue-50': '#eff6ff', /* Light background for gradients */
            'danger-red': '#dc2626',
          }
        }
      }
    }
  </script>
  
  <style>
    body {
        font-family: 'Inter', sans-serif;
    }

    .animate-fade-in {
      animation: fadeIn 0.6s ease-out;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .card {
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        cursor: pointer;
    }
    .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 30px rgba(55, 48, 163, 0.15);
    }
    
    .toast {
      transition: transform 280ms ease, opacity 280ms ease;
      transform: translateY(-10px);
      opacity: 0;
      z-index: 60;
    }
    .toast.show {
      transform: translateY(0);
      opacity: 1;
    }
    
    .btn-logout:hover {
        background-color: #991b1b; /* Red-700 */
        box-shadow: 0 5px 15px rgba(220, 38, 38, 0.3);
    }

    /* Utility classes for view switching */
    .view-container {
        display: none;
    }
    .view-container.active {
        display: block;
    }

    .status-pending { background-color: #fef3c7; color: #b45309; } /* Amber-100 / Amber-700 */
    .status-confirmed { background-color: #d1fae5; color: #065f46; } /* Green-100 / Green-700 */
    .status-cancelled { background-color: #fee2e2; color: #991b1b; } /* Red-100 / Red-700 */

  </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-white font-sans min-h-screen">

  <!-- Loading State Overlay (Added back for better UX during auth check) -->
  <div id="loadingOverlay" class="fixed inset-0 bg-white/70 backdrop-blur-sm flex items-center justify-center z-[100]">
      <div class="text-primary-indigo text-xl font-semibold">Loading Dashboard...</div>
  </div>

  <!-- Navigation Bar -->
  <nav class="bg-white shadow-md">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between items-center h-16">
        <div class="flex items-center">
          <h1 class="text-2xl font-bold text-primary-indigo">Blessings Clinic</h1>
        </div>
        <div class="flex items-center space-x-4">
          <p id="userNameDisplay" class="text-tertiary-slate font-medium hidden md:block">Loading user...</p>
          <button id="logoutBtn" class="bg-danger-red text-white font-semibold py-2 px-4 rounded-lg transition-all duration-200 shadow-md btn-logout">
            Logout
          </button>
        </div>
      </div>
    </div>
  </nav>

  <!-- Main Content Area -->
  <main class="max-w-7xl mx-auto py-8 px-4 sm:px-6 lg:px-8 animate-fade-in">
    
    <div class="mb-8">
      <h2 id="greetingText" class="text-4xl font-extrabold text-gray-800">Hello, Patient.</h2>
      <p class="text-lg text-tertiary-slate mt-2">Welcome to your personalized dashboard.</p>
    </div>

    <!-- MAIN DASHBOARD VIEW -->
    <div id="mainDashboardView" class="view-container active">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
          <!-- Card 1: Appointments (Now Functional) -->
          <div id="appointmentsCard" class="card bg-white p-6 rounded-xl shadow-xl border border-gray-100" data-view="appointmentsView">
            <div class="text-secondary-blue mb-3">
              <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
            </div>
            <h3 class="text-xl font-bold text-primary-indigo mb-2">My Appointments</h3>
            <p class="text-tertiary-slate text-sm mb-4">View your <span id="pendingCount" class="font-bold text-secondary-blue">0 pending</span> and <span id="confirmedCount" class="font-bold text-green-600">0 confirmed</span> visits.</p>
            <span class="text-secondary-blue font-semibold hover:text-primary-indigo transition-colors">Book or View →</span>
          </div>

          <!-- Card 2: Medical Records (Placeholder) -->
          <div class="card bg-white p-6 rounded-xl shadow-xl border border-gray-100">
            <div class="text-secondary-blue mb-3">
              <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>
            </div>
            <h3 class="text-xl font-bold text-primary-indigo mb-2">Medical Records</h3>
            <p class="text-tertiary-slate text-sm mb-4">Access lab results, prescriptions, and visit summaries securely.</p>
            <a href="#" class="text-secondary-blue font-semibold hover:text-primary-indigo transition-colors">View Records →</a>
          </div>

          <!-- Card 3: Contact Doctor (Placeholder) -->
          <div class="card bg-white p-6 rounded-xl shadow-xl border border-gray-100">
            <div class="text-secondary-blue mb-3">
              <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
            </div>
            <h3 class="text-xl font-bold text-primary-indigo mb-2">Contact Us</h3>
            <p class="text-tertiary-slate text-sm mb-4">Send a secure message to your care team or request a call back.</p>
            <a href="#" class="text-secondary-blue font-semibold hover:text-primary-indigo transition-colors">Message Now →</a>
          </div>
        </div>
    </div>

    <!-- APPOINTMENTS MANAGEMENT VIEW -->
    <div id="appointmentsView" class="view-container">
        <button id="backToDashboardBtn" class="mb-6 flex items-center text-primary-indigo hover:text-secondary-blue font-semibold transition-colors">
            <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
            Back to Dashboard
        </button>

        <h3 class="text-3xl font-bold text-primary-indigo mb-6">Manage Appointments</h3>

        <!-- Appointment List -->
        <div class="bg-white p-6 rounded-xl shadow-xl mb-8">
            <h4 class="text-2xl font-semibold text-gray-800 mb-4 border-b pb-2">Upcoming & Recent Visits</h4>
            <div id="appointmentsList" class="space-y-4">
                <!-- Appointments will be injected here -->
                <p id="noAppointments" class="text-tertiary-slate italic">You have no upcoming appointments. Use the form below to book one!</p>
            </div>
        </div>

        <!-- Booking Form -->
        <div class="bg-white p-6 rounded-xl shadow-xl border-t-4 border-secondary-blue">
            <h4 class="text-2xl font-semibold text-secondary-blue mb-4">Book a New Appointment</h4>
            <form id="appointmentForm" class="space-y-4">
                <input type="text" id="childName" name="childName" placeholder="Child's Name" required 
                       class="w-full border p-3 rounded-lg focus:outline-none focus:border-secondary-blue focus:ring-2 focus:ring-blue-100 transition-all">
                <input type="text" id="parentName" name="parentName" placeholder="Parent's Name" required 
                       class="w-full border p-3 rounded-lg focus:outline-none focus:border-secondary-blue focus:ring-2 focus:ring-blue-100 transition-all">
                
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <input type="date" id="appointmentDate" name="date" required 
                           class="w-full border p-3 rounded-lg focus:outline-none focus:border-secondary-blue focus:ring-2 focus:ring-blue-100 transition-all">
                    <input type="time" id="appointmentTime" name="time" required 
                           class="w-full border p-3 rounded-lg focus:outline-none focus:border-secondary-blue focus:ring-2 focus:ring-blue-100 transition-all">
                </div>

                <select id="service" name="service" required 
                        class="w-full border p-3 rounded-lg focus:outline-none focus:border-secondary-blue focus:ring-2 focus:ring-blue-100 transition-all">
                  <option value="">Select Service</option>
                  <option value="Routine Checkup">Routine Checkup - ₹500</option>
                  <option value="Vaccination">Vaccination - ₹300</option>
                  <option value="Specialized Consultation">Specialized Consultation - ₹800</option>
                  <option value="Laboratory Tests">Laboratory Tests - Price varies</option>
                </select>
                <textarea id="notes" name="notes" placeholder="Reason for visit / additional notes (optional)" rows="3"
                          class="w-full border p-3 rounded-lg focus:outline-none focus:border-secondary-blue focus:ring-2 focus:ring-blue-100 transition-all resize-none"></textarea>
                
                <button type="submit" id="bookAppointmentBtn" class="w-full bg-gradient-to-r from-primary-indigo to-secondary-blue text-white py-3 rounded-lg shadow-lg hover:opacity-90 transition-all duration-300 font-semibold">
                  Book Appointment
                </button>
            </form>
        </div>
    </div>
    
  </main>

  <div id="toastWrapper" class="fixed top-5 right-5 z-50 pointer-events-none">
    <div id="toast" class="toast p-4 rounded-lg text-white shadow-lg"></div>
  </div>

  <!-- Cancellation Confirmation Modal -->
  <div id="cancelModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-[100] hidden items-center justify-center p-4">
    <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full animate-fade-in">
        <h4 class="text-xl font-bold text-primary-indigo mb-3">Confirm Cancellation</h4>
        <p class="text-tertiary-slate mb-6">Are you sure you want to cancel this appointment? This action cannot be undone.</p>
        <div class="flex justify-end space-x-3">
            <button id="closeCancelModal" class="px-4 py-2 text-tertiary-slate border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">
                Keep Appointment
            </button>
            <button id="confirmCancelBtn" data-appointment-id="" class="px-4 py-2 bg-danger-red text-white font-semibold rounded-lg hover:bg-red-700 transition-colors shadow-md">
                Yes, Cancel It
            </button>
        </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { 
        getAuth, 
        onAuthStateChanged,
        signOut,
        signInWithCustomToken,
        signInAnonymously
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { 
        getFirestore, 
        collection, 
        query, 
        where, 
        addDoc, 
        onSnapshot,
        doc,
        updateDoc // Added to allow updating document status
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    
    // --- Global Variables (Provided by Canvas Environment) ---
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    // --- Firebase Configuration (Using provided credentials as fallback) ---
    const userProvidedFirebaseConfig = {
      apiKey: "AIzaSyC3GrH4H8rKPqpEA_41NcnX3eIMwuCZ5i4",
      authDomain: "blessings-clinic.firebaseapp.com",
      projectId: "blessings-clinic",
      storageBucket: "blessings-clinic.firebasestorage.app",
      messagingSenderId: "1053278745261",
      appId: "1:1053278745261:web:f00b3853e90a54cc1d8c24"
    };
    
    // Safely parse the environment variable, falling back to an empty object if undefined or invalid.
    let envConfig;
    try {
        envConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
    } catch (e) {
        envConfig = {};
    }

    // Use the environment config if it has an apiKey, otherwise use the hardcoded one.
    // This resolves the "Firebase configuration is missing or empty" error.
    const firebaseConfig = (Object.keys(envConfig).length > 0 && envConfig.apiKey) 
        ? envConfig 
        : userProvidedFirebaseConfig;

    
    // --- Firebase Initialization ---
    let app, auth, db;
    let userId = null;
    let patientData = {}; // Stores name/email for easy form pre-filling

    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      const colors = {
        success: 'bg-secondary-blue',
        error: 'bg-red-600', 
        info: 'bg-primary-indigo'
      };
      
      toast.className = `toast p-4 rounded-lg text-white shadow-lg ${colors[type] || colors.success}`;
      toast.textContent = message;
      
      toast.classList.add('show');
      
      setTimeout(() => {
        toast.classList.remove('show');
      }, 4000);
    }
    
    function initializeFirebase() {
      // The check is now primarily here for console logging, as firebaseConfig is guaranteed to be set.
      if (!firebaseConfig.apiKey) {
        console.error("Firebase configuration is missing or empty.");
        showToast('System Error: Firebase config missing.', 'error');
        return;
      }
      setLogLevel('debug');
      try {
          app = initializeApp(firebaseConfig);
          auth = getAuth(app);
          db = getFirestore(app);

          // Attempt silent sign-in using provided token if available
          if (initialAuthToken) {
              signInWithCustomToken(auth, initialAuthToken).catch(e => {
                  console.error("Custom token sign-in failed, checking existing auth:", e);
              });
          }
      } catch (e) {
          console.error("Firebase initialization failed:", e);
          showToast('FATAL: Firebase setup failed.', 'error');
      }
    }
    
    // --- Appointment Management Functions ---

    /**
     * Shows the cancellation confirmation modal and sets the appointment ID.
     */
    function showCancelConfirmation(appointmentId) {
        const modal = document.getElementById('cancelModal');
        const confirmBtn = document.getElementById('confirmCancelBtn');

        confirmBtn.dataset.appointmentId = appointmentId;
        modal.classList.remove('hidden');
        modal.classList.add('flex');
    }

    /**
     * Hides the cancellation confirmation modal.
     */
    function hideCancelConfirmation() {
        const modal = document.getElementById('cancelModal');
        modal.classList.remove('flex');
        modal.classList.add('hidden');
    }

    /**
     * Updates the appointment status to 'Cancelled' in Firestore.
     */
    async function cancelAppointment(appointmentId) {
        if (!db || !appointmentId) {
            showToast('System not ready or ID missing.', 'error');
            return;
        }

        hideCancelConfirmation(); // Hide modal immediately

        const appointmentsCollectionRef = collection(db, `artifacts/${appId}/public/data/appointments`);
        const apptDocRef = doc(appointmentsCollectionRef, appointmentId);

        try {
            await updateDoc(apptDocRef, {
                status: 'Cancelled',
                cancelledAt: new Date().toISOString()
            });
            showToast('Appointment successfully cancelled.', 'success');
        } catch (error) {
            console.error("Error cancelling appointment:", error);
            showToast('Failed to cancel appointment. Please try again.', 'error');
        }
    }


    // --- Firestore Listeners and Data Display ---

    /**
     * Sets up a real-time listener for the current user's appointments.
     */
    function setupAppointmentsListener(uid) {
        if (!db) return;

        const appointmentsCollectionRef = collection(db, `artifacts/${appId}/public/data/appointments`);
        // Query only appointments for the current patientId
        const q = query(appointmentsCollectionRef, where('patientId', '==', uid));

        const appointmentsListDiv = document.getElementById('appointmentsList');
        const noAppointmentsMsg = document.getElementById('noAppointments');
        const pendingCountSpan = document.getElementById('pendingCount');
        const confirmedCountSpan = document.getElementById('confirmedCount');
        
        onSnapshot(q, (snapshot) => {
            let appointmentsHtml = '';
            let pendingCount = 0;
            let confirmedCount = 0;
            
            // Map and sort appointments by date and time (newest first)
            const appointments = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))
                .sort((a, b) => {
                    const dateTimeA = new Date(`${a.appointmentDate}T${a.appointmentTime}`);
                    const dateTimeB = new Date(`${b.appointmentDate}T${b.appointmentTime}`);
                    return dateTimeA - dateTimeB; // Ascending order
                });

            if (appointments.length === 0) {
                noAppointmentsMsg.classList.remove('hidden');
                appointmentsListDiv.innerHTML = '';
            } else {
                noAppointmentsMsg.classList.add('hidden');
                
                appointments.forEach(app => {
                    const statusClass = `status-${app.status.toLowerCase()}`;
                    if (app.status === 'Pending') pendingCount++;
                    if (app.status === 'Confirmed') confirmedCount++;
                    
                    let actionButton = '';
                    // Only allow cancellation if pending or confirmed
                    if (app.status === 'Pending' || app.status === 'Confirmed') {
                        actionButton = `
                            <button data-id="${app.id}" class="cancel-appt-btn text-xs font-semibold text-danger-red hover:text-red-700 mt-2 p-1 border border-danger-red rounded-lg hover:bg-red-50 transition-colors">
                                Cancel
                            </button>
                        `;
                    }

                    appointmentsHtml += `
                        <div class="p-4 rounded-lg shadow-sm border ${statusClass} flex flex-col md:flex-row md:justify-between md:items-center hover:shadow-md transition-shadow">
                            <div class="flex-grow">
                                <p class="text-lg font-bold">${app.childName} (${app.service})</p>
                                <p class="text-sm mt-1">
                                    <span class="font-medium">${app.appointmentDate}</span> at <span class="font-medium">${app.appointmentTime}</span>
                                </p>
                                <p class="text-xs text-gray-600 mt-2">${app.reason.substring(0, 50)}${app.reason.length > 50 ? '...' : ''}</p>
                            </div>
                            <div class="flex flex-col items-start md:items-end mt-3 md:mt-0 space-y-2">
                                <span class="px-3 py-1 text-xs font-semibold rounded-full uppercase self-end md:self-auto ${statusClass}">${app.status}</span>
                                ${actionButton}
                            </div>
                        </div>
                    `;
                });

                appointmentsListDiv.innerHTML = appointmentsHtml;
                
                // Attach event listeners to the new cancel buttons
                appointmentsListDiv.querySelectorAll('.cancel-appt-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => showCancelConfirmation(e.target.dataset.id));
                });
            }

            // Update card counts
            pendingCountSpan.textContent = `${pendingCount} pending`;
            confirmedCountSpan.textContent = `${confirmedCount} confirmed`;
            
        }, (error) => {
            console.error("Error listening to appointments:", error);
            showToast('Could not load appointments.', 'error');
        });
    }

    /**
     * Sets up a real-time listener for the current user's profile data to pre-fill the form.
     */
    function setupProfileListener(uid) {
        if (!db) return;

        // Note: Assuming public/data/users stores basic profile info linked to auth UID
        const patientDocRef = doc(db, `artifacts/${appId}/public/data/users`, uid);
        
        onSnapshot(patientDocRef, (docSnap) => {
            if (docSnap.exists()) {
                patientData = docSnap.data();
                // Pre-fill form if data is available
                document.getElementById('childName').value = patientData.childName || '';
                document.getElementById('parentName').value = patientData.parentName || patientData.name || '';
            } else {
                console.log("No initial patient profile found.");
            }
        }, (error) => {
            console.error("Error listening to patient profile:", error);
        });
    }

    /**
     * Handles new appointment booking submission.
     */
    async function handleBookAppointment(event) {
        event.preventDefault();

        if (!userId || !db) {
            showToast('System not ready. Please wait for authentication.', 'error');
            return;
        }

        const form = event.target;
        const childName = form.childName.value.trim();
        const parentName = form.parentName.value.trim();
        const date = form.date.value;
        const time = form.time.value;
        const service = form.service.value;
        const notes = form.notes.value.trim();
        
        const bookAppointmentBtn = document.getElementById('bookAppointmentBtn');

        if (!childName || !parentName || !date || !time || !service) {
            showToast('Please fill in all required fields.', 'error');
            return;
        }

        // --- Time Validation (Prevent past appointments on the same day) ---
        const today = new Date().toISOString().split('T')[0];
        if (date < today) {
             showToast('Cannot book an appointment in the past.', 'error');
             return;
        }
        
        if (date === today) {
            const now = new Date();
            const appointmentDateTime = new Date(`${date}T${time}:00`);

            if (appointmentDateTime < now) {
                showToast('The selected time is in the past. Please select a future time for today.', 'error');
                return;
            }
        }
        
        const patientEmail = auth.currentUser?.email || 'N/A';
        
        const appointmentData = {
            patientId: userId,
            patientEmail: patientEmail,
            childName: childName,
            parentName: parentName,
            appointmentDate: date,
            appointmentTime: time,
            service: service,
            reason: notes || 'Routine appointment.',
            status: 'Pending', // Default status for new bookings
            createdAt: new Date().toISOString()
        };

        const appointmentsCollectionRef = collection(db, `artifacts/${appId}/public/data/appointments`);

        bookAppointmentBtn.disabled = true;
        bookAppointmentBtn.textContent = 'Booking...';

        try {
            await addDoc(appointmentsCollectionRef, appointmentData);
            showToast('Appointment booked successfully! Our staff will confirm shortly.', 'success');
            form.reset();
            // Re-prefill parent/child name
            document.getElementById('childName').value = patientData.childName || '';
            document.getElementById('parentName').value = patientData.parentName || patientData.name || '';
            
            // Switch back to the dashboard view immediately after successful booking
            switchView('mainDashboardView'); 
            
        } catch (error) {
            console.error("Error booking appointment:", error);
            showToast('Failed to book appointment. Check console.', 'error');
        } finally {
            bookAppointmentBtn.disabled = false;
            bookAppointmentBtn.textContent = 'Book Appointment';
        }
    }


    // --- UI and Event Handlers ---

    function switchView(viewId) {
        document.querySelectorAll('.view-container').forEach(view => {
            view.classList.remove('active');
        });
        const targetView = document.getElementById(viewId);
        if (targetView) {
            targetView.classList.add('active');
            window.scrollTo({ top: 0, behavior: 'smooth' }); // Scroll to top for better UX
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
      const loadingOverlay = document.getElementById('loadingOverlay');

      initializeFirebase();
      
      const greetingText = document.getElementById('greetingText');
      const userNameDisplay = document.getElementById('userNameDisplay');
      const logoutBtn = document.getElementById('logoutBtn');
      const appointmentsCard = document.getElementById('appointmentsCard');
      const backToDashboardBtn = document.getElementById('backToDashboardBtn');
      const appointmentForm = document.getElementById('appointmentForm');

      const cancelModal = document.getElementById('cancelModal');
      const closeCancelModal = document.getElementById('closeCancelModal');
      const confirmCancelBtn = document.getElementById('confirmCancelBtn');


      // Set minimum date to today for the booking form
      const dateInput = document.getElementById('appointmentDate');
      if (dateInput) {
        const today = new Date().toISOString().split('T')[0];
        dateInput.min = today;
      }

      // 1. Check Authentication Status
      onAuthStateChanged(auth, (user) => {
        if (user) {
          // Check if this user is the admin (should be redirected to admin.html)
          if (user.email === 'admin@blessings.com') {
              showToast('Admin detected. Redirecting...', 'info');
              // window.location.href = 'admin.html'; // Uncomment once admin.html exists
              // return;
          }
          
          userId = user.uid;
          
          // User is signed in (Patient/Standard User)
          const userName = user.displayName || user.email || 'Patient';
          greetingText.textContent = `Hello, ${userName.split(' ')[0]}.`;
          userNameDisplay.textContent = user.isAnonymous ? `Patient ID: ${userId.substring(0, 8)}...` : userName;
          userNameDisplay.classList.remove('hidden');

          // Initialize Data Listeners
          setupAppointmentsListener(userId);
          setupProfileListener(userId);
          
          loadingOverlay.classList.add('hidden'); // Hide loading once user is confirmed
        } else {
          // User is signed out. Redirect to login.
          showToast('You must be logged in to view the dashboard.', 'error');
          loadingOverlay.classList.add('hidden');
          setTimeout(() => {
            // window.location.href = 'login.html'; // Uncomment once login.html exists
          }, 1500);
        }
      });
      
      // 2. Logout Handler
      logoutBtn.addEventListener('click', async () => {
        try {
            await signOut(auth);
            showToast('You have been logged out successfully.', 'success');
            setTimeout(() => {
                // window.location.href = 'login.html'; // Uncomment once login.html exists
            }, 1000);
        } catch (error) {
            console.error("Logout Error:", error);
            showToast('Failed to log out. Please try again.', 'error');
        }
      });
      
      // 3. View Switchers
      if (appointmentsCard) {
        appointmentsCard.addEventListener('click', () => switchView('appointmentsView'));
      }
      if (backToDashboardBtn) {
        backToDashboardBtn.addEventListener('click', () => switchView('mainDashboardView'));
      }

      // 4. Appointment Form Handler
      if (appointmentForm) {
          appointmentForm.addEventListener('submit', handleBookAppointment);
      }
      
      // 5. Cancellation Modal Handlers
      if (closeCancelModal) {
          closeCancelModal.addEventListener('click', hideCancelConfirmation);
      }
      if (confirmCancelBtn) {
          confirmCancelBtn.addEventListener('click', (e) => {
              const apptId = e.target.dataset.appointmentId;
              if (apptId) {
                  cancelAppointment(apptId);
              } else {
                  showToast('Error: Appointment ID missing.', 'error');
                  hideCancelConfirmation();
              }
          });
      }
      
    });
  </script>
</body>
</html>
